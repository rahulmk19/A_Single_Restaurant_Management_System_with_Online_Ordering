<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FoodTasteNow - Home</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      integrity="sha512-Fo3rlrZj/k7ujTnHqT7LKy2tT1Y4B6L5O/6x3Z4I3V9B+4uX1Rm2B0s1KjF9xzp2KVVjvbHAfO9wDVWD1Z5gXg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Dropdown styling */
      .dropdown-menu {
        display: none;
        position: absolute;
        background-color: white;
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        border-radius: 0.5rem;
        overflow: hidden;
        z-index: 50;
      }
      .dropdown-menu a {
        display: block;
        padding: 0.5rem 1rem;
        color: #333;
        text-decoration: none;
        transition: background-color 0.2s;
      }
      .dropdown-menu a:hover {
        background-color: #f1f1f1;
      }
      .open .dropdown-menu {
        display: block;
      }
      /* Make room for fixed header */
      body {
        padding-top: 80px;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <!-- Fixed Navbar (Header) -->
    <nav
      class="fixed top-0 left-0 right-0 bg-gradient-to-r from-red-500 to-pink-500 p-4 shadow-lg z-50"
    >
      <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center space-x-6">
          <div class="logo">
            <a
              href="index.html"
              class="text-white font-extrabold text-3xl tracking-wide"
              >FoodTasteNow</a
            >
          </div>
          <div class="nav-links hidden md:flex space-x-4" id="navLinks">
            <a href="index.html" class="text-white hover:text-gray-200">Home</a>
            <a href="category.html" class="text-white hover:text-gray-200"
              >Category</a
            >
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <!-- Desktop Search Bar -->
          <div class="search-bar hidden md:flex">
            <input
              type="text"
              placeholder="Search products..."
              id="searchInput"
              class="px-3 py-2 rounded-l-lg border focus:outline-none"
            />
            <button
              onclick="searchItems()"
              class="px-4 py-2 bg-white text-red-500 rounded-r-lg hover:bg-red-100"
            >
              Search
            </button>
          </div>
          <div class="auth" id="authSection">
            <a href="User/login.html" class="text-white">Sign In</a>
          </div>
          <!-- Mobile Hamburger -->
          <button
            class="md:hidden text-white focus:outline-none"
            onclick="toggleMobileMenu()"
          >
            <i class="fas fa-bars text-2xl"></i>
          </button>
        </div>
      </div>
    </nav>
    <!-- Mobile Menu -->
    <div
      class="mobile-menu hidden md:hidden bg-red-500 text-white p-4 fixed top-16 w-full z-40"
      id="mobileMenu"
    >
      <a href="index.html" class="block py-2">Home</a>
      <a href="category.html" class="block py-2">Category</a>
      <a href="User/login.html" class="block py-2">Sign In</a>
    </div>
    <!-- Page Content -->
    <div
      class="max-w-6xl mx-auto mt-10 bg-white p-6 rounded-lg shadow-lg text-center"
    >
      <div
        id="menuItems"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
      >
        <!-- Menu items will be dynamically inserted here -->
      </div>
    </div>
    <!-- Footer -->
    <footer class="bg-pink-500 text-white py-8">
      <div class="container mx-auto flex flex-wrap lg:flex-nowrap gap-6">
        <!-- Left Section: About, Help, Policy, Social -->
        <div class="w-full lg:w-2/3 grid grid-cols-2 md:grid-cols-4 gap-6">
          <div>
            <h2 class="font-semibold mb-4">ABOUT</h2>
            <ul>
              <li><a href="#" class="hover:underline">Contact Us</a></li>
              <li><a href="#" class="hover:underline">About Us</a></li>
              <li><a href="#" class="hover:underline">Careers</a></li>
              <li><a href="#" class="hover:underline">Press</a></li>
            </ul>
          </div>
          <div>
            <h2 class="font-semibold mb-4">HELP</h2>
            <ul>
              <li><a href="#" class="hover:underline">Payments</a></li>
              <li><a href="#" class="hover:underline">Shipping</a></li>
              <li>
                <a href="#" class="hover:underline">Cancellation & Returns</a>
              </li>
              <li><a href="#" class="hover:underline">FAQ</a></li>
            </ul>
          </div>
          <div>
            <h2 class="font-semibold mb-4">POLICY</h2>
            <ul>
              <li><a href="#" class="hover:underline">Return Policy</a></li>
              <li><a href="#" class="hover:underline">Terms Of Use</a></li>
              <li><a href="#" class="hover:underline">Security</a></li>
              <li><a href="#" class="hover:underline">Privacy</a></li>
            </ul>
          </div>
          <div>
            <h2 class="font-semibold mb-4">SOCIAL</h2>
            <ul>
              <li><a href="#" class="hover:underline">Facebook</a></li>
              <li><a href="#" class="hover:underline">Twitter</a></li>
              <li><a href="#" class="hover:underline">YouTube</a></li>
            </ul>
          </div>
        </div>
        <!-- Right Section: Contact Us -->
        <div class="w-full lg:w-1/3">
          <h2 class="font-semibold mb-4">CONTACT US</h2>
          <ul class="space-y-3">
            <li>
              <a
                href="https://www.instagram.com"
                target="_blank"
                class="flex items-center hover:underline"
              >
                <img
                  src="https://img.icons8.com/ios-filled/24/ffffff/instagram-new.png"
                  class="mr-2"
                  alt="Instagram"
                />
                Instagram
              </a>
            </li>
            <li>
              <a
                href="https://www.facebook.com"
                target="_blank"
                class="flex items-center hover:underline"
              >
                <img
                  src="https://img.icons8.com/ios-filled/24/ffffff/facebook-circled--v1.png"
                  class="mr-2"
                  alt="Facebook"
                />
                Facebook
              </a>
            </li>
            <li>
              <a
                href="mailto:rahulmk.94802@gmail.com"
                class="flex items-center hover:underline"
              >
                <img
                  src="https://img.icons8.com/ios-filled/24/ffffff/email.png"
                  class="mr-2"
                  alt="Email"
                />
                Email
              </a>
            </li>
            <li>
              <a
                href="https://rahulmk19.github.io/"
                target="_blank"
                class="flex items-center hover:underline"
              >
                <img
                  src="https://img.icons8.com/ios-filled/24/ffffff/internet.png"
                  class="mr-2"
                  alt="Portfolio"
                />
                Portfolio
              </a>
            </li>
            <li>
              <a
                href="tel:1234567890"
                class="flex items-center hover:underline"
              >
                <img
                  src="https://img.icons8.com/ios-filled/24/ffffff/phone.png"
                  class="mr-2"
                  alt="Phone"
                />
                +91 766-786-9850
              </a>
            </li>
          </ul>
        </div>
      </div>

      <div
        class="container mx-auto mt-8 border-t border-gray-700 pt-4 text-center text-sm"
      >
        Â© 2025 FoodTasteNow Pvt Ltd. All rights reserved.
      </div>
    </footer>

    <script>
      // Global variables
      let allItems = [];
      let cartMap = {}; // Maps menuItemId to cart item id

      // Toggle Mobile Menu
      function toggleMobileMenu() {
        const mobileMenu = document.getElementById("mobileMenu");
        mobileMenu.classList.toggle("hidden");
      }

      // Decode the JWT and return firstName or username
      function getNameFromToken() {
        const token = localStorage.getItem("jwtToken");
        if (!token) return null;
        try {
          const payloadBase64 = token.split(".")[1];
          const payload = JSON.parse(atob(payloadBase64));
          // Adjust if your JWT includes firstName, username, name, sub, etc.
          return (
            payload.firstName ||
            payload.username ||
            payload.name ||
            payload.sub ||
            null
          );
        } catch (error) {
          console.error("Error decoding token:", error);
          return null;
        }
      }

      // Decode the JWT and return the roles
      function getUserRoleFromToken() {
        const token = localStorage.getItem("jwtToken");
        if (!token) return null;

        try {
          const payloadBase64 = token.split(".")[1];
          const payload = JSON.parse(atob(payloadBase64));

          // If there's at least one authority, return it
          if (payload.authorities && payload.authorities.length > 0) {
            return payload.authorities[0].authority; // e.g. "ROLE_USER" or "ROLE_ADMIN"
          } else {
            return null;
          }
        } catch (error) {
          console.error("Error decoding token:", error);
          return null;
        }
      }

      // Update Navbar based on login status
      function updateNavbar() {
        const authDiv = document.getElementById("authSection");
        const name = getNameFromToken();
        const role = getUserRoleFromToken();

        // Remove existing cart button if any
        const existingCartButton = document.getElementById("cartButton");
        if (existingCartButton) {
          existingCartButton.remove();
        }

        // If user is not logged in, just show "Sign In"
        if (!name) {
          authDiv.innerHTML = `<a href="User/login.html" class="text-white">Sign In</a>`;
          return;
        }
        // If user is admin, redirect to admin dashboard
        if (role === "ROLE_ADMIN") {
          window.location.href = "/Admin/adminDashboard.html";
          return;
        }

        // Otherwise, show normal user navbar
        authDiv.innerHTML = `
          <div class="flex items-center space-x-4">
            <div class="relative inline-block" id="userDropdownContainer">
              <button id="userDropdownButton" class="text-white focus:outline-none inline-flex items-center">
                <span>${name}</span>
                <i class="fas fa-caret-down ml-1"></i>
              </button>
              <div id="userDropdown" class="dropdown-menu">
                <a href="profile.html">My Profile</a>
                <a href="Orders/allOrders.html">Orders</a>
                <a href="coupons.html">Coupon</a>
                <a href="notifications.html">Notifications</a>
                <a href="#" id="logout">Logout</a>
              </div>
            </div>
            <a id="cartButton" href="./Cart/cart.html" class="bg-green-500 text-white border border-green-500 px-6 py-2 rounded-full hover:bg-green-600 flex items-center justify-center space-x-2">
              <i class="fas fa-shopping-cart text-2xl"></i>
              <span class="text-lg font-normal">Cart</span>
            </a>
          </div>
        `;

        // Dropdown events
        const dropdownContainer = document.getElementById(
          "userDropdownContainer"
        );
        dropdownContainer.addEventListener("mouseenter", () => {
          dropdownContainer.classList.add("open");
        });
        dropdownContainer.addEventListener("mouseleave", () => {
          dropdownContainer.classList.remove("open");
        });

        // Logout
        document.getElementById("logout").addEventListener("click", (e) => {
          e.preventDefault();
          localStorage.removeItem("jwtToken");
          localStorage.removeItem('loginData');
          window.location.href = "index.html";
        });

        // Fetch cart data to update UI
        fetchCartData();
      }

      // Fetch all menu items from backend
      async function fetchMenuItems() {
        try {
          const response = await fetch(
            "http://localhost:8081/foodtastenow/items/public-api/getAll"
          );
          if (response.ok) {
            allItems = await response.json();
            displayMenuItems(allItems);
          } else {
            console.error("Failed to fetch menu items");
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // Fetch cart data for logged in user
      async function fetchCartData() {
        const token = localStorage.getItem("jwtToken");
        if (!token) return;
        try {
          const response = await fetch(
            "http://localhost:8081/foodtastenow/cart/user",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          if (response.ok) {
            const cart = await response.json();
            cartMap = {};
            if (cart.cartItem && Array.isArray(cart.cartItem)) {
              cart.cartItem.forEach((item) => {
                cartMap[item.menuItem.id] = item.id;
              });
            }
            updateCartBadge(cart);
            displayMenuItems(allItems);
          } else {
            console.error("Failed to fetch cart data");
          }
        } catch (error) {
          console.error("Error fetching cart data:", error);
        }
      }

      // Display menu items in grid layout
      function displayMenuItems(items) {
        const menuItemsContainer = document.getElementById("menuItems");
        menuItemsContainer.innerHTML = "";
        const isLoggedIn = getNameFromToken() !== null;

        items.forEach((item) => {
          const itemCard = document.createElement("div");
          itemCard.className =
            "bg-white border rounded-lg p-4 shadow hover:shadow-lg transition-transform transform hover:scale-105";
          itemCard.innerHTML = `
            <img src="${item.imageUrl}" alt="${
            item.name
          }" class="w-full h-48 object-cover rounded-lg mb-4">
            <h2 class="text-xl font-bold mb-2 text-gray-800">${item.name}</h2>
            <p class="text-gray-600 mb-2">Category: ${item.category}</p>
            <p class="text-red-500 text-lg font-semibold mb-4">â¹${item.price.toFixed(
              2
            )}</p>
          `;

          const cartButton = document.createElement("button");
          cartButton.className =
            "bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors";

          if (isLoggedIn) {
            if (cartMap[item.id]) {
              cartButton.textContent = "Remove from Cart";
              cartButton.classList.remove("bg-blue-500", "hover:bg-blue-600");
              cartButton.classList.add("bg-red-500", "hover:bg-red-600");
            } else {
              cartButton.textContent = "Add to Cart";
            }
            cartButton.addEventListener("click", () =>
              toggleCartItem(item.id, cartButton)
            );
          } else {
            cartButton.textContent = "Add to Cart";
            cartButton.addEventListener("click", () => {
              window.location.href = "User/login.html";
            });
          }

          itemCard.appendChild(cartButton);
          menuItemsContainer.appendChild(itemCard);
        });
      }

      // Add item to cart
      async function addToCart(menuItemId, button) {
        const token = localStorage.getItem("jwtToken");
        try {
          const response = await fetch(
            `http://localhost:8081/foodtastenow/cart/user/save/${menuItemId}`,
            {
              method: "POST",
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          if (response.ok) {
            const cart = await response.json();
            if (cart.cartItem && Array.isArray(cart.cartItem)) {
              cart.cartItem.forEach((item) => {
                if (item.menuItem.id === menuItemId) {
                  cartMap[menuItemId] = item.id;
                }
              });
            }
            button.textContent = "Remove from Cart";
            button.classList.remove("bg-blue-500", "hover:bg-blue-600");
            button.classList.add("bg-red-500", "hover:bg-red-600");
            updateCartBadge(cart);
          } else {
            console.error(
              "Failed to add item to cart",
              response.status,
              await response.text()
            );
          }
        } catch (error) {
          console.error("Error adding item to cart:", error);
        }
      }

      // Remove item from cart
      async function removeFromCart(menuItemId, button) {
        const token = localStorage.getItem("jwtToken");
        try {
          const response = await fetch(
            `http://localhost:8081/foodtastenow/cart/user/delete/${menuItemId}`,
            {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          if (response.ok) {
            const cart = await response.json();
            delete cartMap[menuItemId];
            button.textContent = "Add to Cart";
            button.classList.remove("bg-red-500", "hover:bg-red-600");
            button.classList.add("bg-blue-500", "hover:bg-blue-600");
            updateCartBadge(cart);
          } else {
            console.error(
              "Failed to remove item from cart",
              response.status,
              await response.text()
            );
          }
        } catch (error) {
          console.error("Error removing item from cart:", error);
        }
      }

      // Toggle between adding and removing item from cart
      function toggleCartItem(menuItemId, button) {
        if (cartMap[menuItemId]) {
          removeFromCart(menuItemId, button);
        } else {
          addToCart(menuItemId, button);
        }
      }

      // Update the cart badge with total quantity
      function updateCartBadge(cart) {
        const cartButton = document.getElementById("cartButton");
        if (cartButton) {
          let badge = document.getElementById("cartBadge");
          if (!badge) {
            badge = document.createElement("span");
            badge.id = "cartBadge";
            badge.className = "bg-yellow-500 text-black rounded-full px-2 ml-2";
            cartButton.appendChild(badge);
          }
          badge.textContent = cart.totalQty || 0;
        }
      }

      // Search functionality
      function searchItems() {
        const query = document
          .getElementById("searchInput")
          .value.trim()
          .toLowerCase();
        const filtered = allItems.filter((item) =>
          item.name.toLowerCase().includes(query)
        );
        displayMenuItems(filtered);
      }

      document
        .getElementById("searchInput")
        .addEventListener("input", function () {
          searchItems();
        });

      // Initialize on DOM load
      document.addEventListener("DOMContentLoaded", () => {
        updateNavbar();
        fetchMenuItems();
      });
    </script>
  </body>
</html>
